{
  "project": "local-credential-storage",
  "spec": "local-credential-storage.md",
  "tasks": [
    {
      "id": "credential-service",
      "name": "Mobile: Credential Storage Service",
      "deps": [],
      "prompt": "Create src/services/credential.ts with functions: saveCredentialId(credentialId: string): Promise<void> saves to AsyncStorage with key 'odyssey_credential_id'; getCredentialId(): Promise<string | null> retrieves from AsyncStorage; clearCredentialId(): Promise<void> removes from AsyncStorage. Export all functions and add to src/services/index.ts.",
      "acceptance": [
        "File exists at src/services/credential.ts",
        "saveCredentialId saves string to AsyncStorage key 'odyssey_credential_id'",
        "getCredentialId returns string or null",
        "clearCredentialId removes the key",
        "All functions exported from src/services/index.ts",
        "TypeScript compiles: cd ~/odyssey-mobile-v3 && npx tsc --noEmit"
      ],
      "estimatedIterations": 4
    },
    {
      "id": "save-on-wallet-creation",
      "name": "Mobile: Save Credential on Wallet Creation",
      "deps": ["credential-service"],
      "prompt": "In src/screens/OnboardingScreen.tsx, after successful Passkey.create() call, extract the credentialId from the response (result.id) and call saveCredentialId() to store it locally. Import saveCredentialId from services/credential.",
      "acceptance": [
        "Import saveCredentialId from ../../services/credential",
        "After Passkey.create() success, calls saveCredentialId(result.id)",
        "Handles case where result.id might be undefined (skip save)",
        "Does not block wallet creation if save fails (try/catch, log warning)",
        "TypeScript compiles"
      ],
      "estimatedIterations": 4
    },
    {
      "id": "save-on-mobile-link",
      "name": "Mobile: Save Credential on Mobile Link",
      "deps": ["credential-service"],
      "prompt": "Find the mobile link flow (likely in LinkWalletScreen.tsx or similar) where Passkey.create() is called for linking a new device. After successful passkey creation, call saveCredentialId(result.id). If no such screen exists, note that in completion message.",
      "acceptance": [
        "Identify mobile link screen with Passkey.create()",
        "After successful link, save credentialId locally",
        "Does not block linking if save fails",
        "TypeScript compiles",
        "OR: Document that no mobile link screen exists yet"
      ],
      "estimatedIterations": 5
    },
    {
      "id": "use-local-credential-approval",
      "name": "Mobile: Use Local Credential in Session Approval",
      "deps": ["credential-service"],
      "prompt": "In src/screens/agents/AgentsScreen.tsx handleModalApprove function, replace the server-side approvalData.credentialId with locally stored credential. At start of function, call getCredentialId(). Use local credential for allowCredentials if available. Remove usage of approvalData.credentialId. Keep the fallback to discoverable flow if passkey fails.",
      "acceptance": [
        "Import getCredentialId from ../../services/credential",
        "Call getCredentialId() at start of handleModalApprove",
        "Use local credentialId for allowCredentials (not approvalData.credentialId)",
        "Falls back to discoverable if no local credential",
        "Falls back to discoverable if passkey fails with local credential",
        "TypeScript compiles"
      ],
      "estimatedIterations": 6
    },
    {
      "id": "save-after-approval",
      "name": "Mobile: Save Credential After Successful Approval",
      "deps": ["credential-service", "use-local-credential-approval"],
      "prompt": "In src/screens/agents/AgentsScreen.tsx, after successful Passkey.get() in handleModalApprove, if we don't have a local credentialId stored, save the one from the response (result.id). This ensures credential is captured even on first approval. Import saveCredentialId if not already imported.",
      "acceptance": [
        "After successful Passkey.get(), check if local credential was missing",
        "If missing, call saveCredentialId(result.id)",
        "Does not save if we already had local credential",
        "Does not block approval if save fails",
        "TypeScript compiles"
      ],
      "estimatedIterations": 5
    },
    {
      "id": "remove-server-credential-dependency",
      "name": "Mobile: Remove Server Credential Dependency",
      "deps": ["use-local-credential-approval"],
      "prompt": "In src/services/sessions.ts, remove credentialId from SessionApprovalData interface since we no longer use it from server. Update getSessionApprovalData to not expect credentialId in response (make it optional or remove). Also update any other files that reference approvalData.credentialId.",
      "acceptance": [
        "credentialId removed or made optional in SessionApprovalData interface",
        "No TypeScript errors from missing credentialId",
        "Mobile approval flow works without server credentialId",
        "TypeScript compiles"
      ],
      "estimatedIterations": 4
    }
  ],
  "mergeOrder": [
    "credential-service",
    "save-on-wallet-creation",
    "save-on-mobile-link",
    "use-local-credential-approval",
    "save-after-approval",
    "remove-server-credential-dependency"
  ]
}
