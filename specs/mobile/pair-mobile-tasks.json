{
  "feature": "mobile-device-pairing",
  "spec": "~/odyssey-mobile-v3/specs/mobile/pair-mobile.md",
  "repos": {
    "api": "~/agentic-wallet/packages/api",
    "bot": "~/agentic-wallet/packages/bot",
    "mobile": "~/odyssey-mobile-v3"
  },
  "tasks": [
    {
      "id": "api-token-endpoints",
      "name": "API: Token generation and validation endpoints",
      "description": "Add POST /api/pair-mobile/generate and GET /api/pair-mobile/:token endpoints",
      "status": "pending",
      "dependencies": [],
      "repo": "api",
      "files": ["~/agentic-wallet/packages/api/src/index.ts"],
      "acceptance": [
        "POST /api/pair-mobile/generate creates token with walletPubkey + telegramId",
        "Token stored in memory with 10min expiry",
        "GET /api/pair-mobile/:token returns wallet info if valid",
        "Returns error if expired/invalid/used"
      ]
    },
    {
      "id": "api-register-endpoint",
      "name": "API: Passkey registration endpoint",
      "description": "Add POST /api/pair-mobile/register to receive mobile passkey",
      "status": "pending",
      "dependencies": ["api-token-endpoints"],
      "repo": "api",
      "files": ["~/agentic-wallet/packages/api/src/index.ts"],
      "acceptance": [
        "Receives credentialId, publicKey, rpIdHash",
        "Validates token exists and not used",
        "Stores passkey data with token",
        "Sends approval request to Telegram",
        "Returns requestId for tracking"
      ]
    },
    {
      "id": "api-devices-endpoint",
      "name": "API: List paired devices endpoint",
      "description": "Add GET /api/devices/:walletPubkey to list paired mobile devices",
      "status": "pending",
      "dependencies": [],
      "repo": "api",
      "files": ["~/agentic-wallet/packages/api/src/index.ts"],
      "acceptance": [
        "Returns list of paired mobile devices for wallet",
        "Includes device name, pairedAt, status",
        "Returns empty array if no devices"
      ]
    },
    {
      "id": "api-unpair-endpoint",
      "name": "API: Unpair device endpoint",
      "description": "Add POST /api/devices/unpair for removing mobile authority",
      "status": "pending",
      "dependencies": ["api-devices-endpoint"],
      "repo": "api",
      "files": ["~/agentic-wallet/packages/api/src/index.ts"],
      "acceptance": [
        "Receives deviceId and owner signature",
        "Calls remove_authority on Lazorkit",
        "Removes device from store",
        "Returns success/tx signature"
      ]
    },
    {
      "id": "web-pair-mobile-page",
      "name": "Web: /pair-mobile page",
      "description": "Create web page for passkey creation flow",
      "status": "pending",
      "dependencies": ["api-token-endpoints"],
      "repo": "api",
      "files": ["~/agentic-wallet/packages/api/src/pages.ts"],
      "acceptance": [
        "Validates token on page load",
        "Shows wallet info (truncated address)",
        "Create Passkey button triggers WebAuthn",
        "Posts passkey to /api/pair-mobile/register",
        "Shows waiting/success/error states",
        "Mobile-friendly responsive design",
        "Odyssey gold theme"
      ]
    },
    {
      "id": "bot-pair-mobile-command",
      "name": "Bot: /pair-mobile command",
      "description": "Add Telegram command to generate QR code",
      "status": "pending",
      "dependencies": ["api-token-endpoints"],
      "repo": "bot",
      "files": ["~/agentic-wallet/packages/bot/src/index.ts"],
      "acceptance": [
        "/pair-mobile generates token via API",
        "Displays QR code image",
        "Shows URL as text backup",
        "Shows expiry time (10 min)"
      ]
    },
    {
      "id": "bot-devices-command",
      "name": "Bot: /devices command",
      "description": "Add Telegram command to view paired devices",
      "status": "pending",
      "dependencies": ["api-devices-endpoint"],
      "repo": "bot",
      "files": ["~/agentic-wallet/packages/bot/src/index.ts"],
      "acceptance": [
        "/devices lists all paired mobile devices",
        "Shows device name, paired date, status",
        "Unpair button for each device",
        "Pair New Device button if < max devices",
        "Empty state if no devices"
      ]
    },
    {
      "id": "bot-approval-callback",
      "name": "Bot: Mobile pairing approval callback",
      "description": "Handle approval/deny for mobile pairing requests",
      "status": "pending",
      "dependencies": ["api-register-endpoint"],
      "repo": "bot",
      "files": ["~/agentic-wallet/packages/bot/src/index.ts"],
      "acceptance": [
        "Shows approval request message with device info",
        "Approve button opens add_authority webview",
        "Deny button cancels request",
        "Success notification after approval"
      ]
    },
    {
      "id": "api-approve-endpoint",
      "name": "API: Add authority approval endpoint",
      "description": "Add POST /api/pair-mobile/approve for on-chain add_authority",
      "status": "pending",
      "dependencies": ["api-register-endpoint"],
      "repo": "api",
      "files": ["~/agentic-wallet/packages/api/src/index.ts"],
      "acceptance": [
        "Receives owner signature from webview",
        "Builds add_authority transaction",
        "Submits to Solana (devnet)",
        "Updates token status to approved",
        "Returns tx signature"
      ]
    },
    {
      "id": "web-approve-page",
      "name": "Web: Add authority approval page",
      "description": "Webview page for owner to sign add_authority",
      "status": "pending",
      "dependencies": ["api-approve-endpoint"],
      "repo": "api",
      "files": ["~/agentic-wallet/packages/api/src/pages.ts"],
      "acceptance": [
        "Shows mobile device info",
        "Sign with Passkey button",
        "Triggers WebAuthn assertion",
        "Posts to /api/pair-mobile/approve",
        "Shows success/close state"
      ]
    },
    {
      "id": "integration-test",
      "name": "Integration: End-to-end test",
      "description": "Test full flow from /pair-mobile to on-chain authority",
      "status": "pending",
      "dependencies": [
        "bot-pair-mobile-command",
        "bot-devices-command",
        "web-pair-mobile-page",
        "bot-approval-callback",
        "web-approve-page"
      ],
      "repos": ["api", "bot"],
      "files": [],
      "acceptance": [
        "Bot generates QR code",
        "Mobile browser creates passkey",
        "Telegram shows approval request",
        "Owner approves, tx confirmed",
        "Mobile passkey can sign session approvals",
        "/devices shows paired device"
      ]
    }
  ],
  "deploy": {
    "api": "sudo systemctl restart odyssey-api",
    "bot": "sudo systemctl restart odyssey-bot"
  }
}
